<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Korkometr PRO — Single-file 2025</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Maps – callback=init żeby nie było szarej mapy na starcie -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk&libraries=places&callback=init&loading=async">
</script>

<style>
  :root{--bg:#f5f7fa;--card:#fff;--text:#111;--accent:#1565c0;--muted:#6b7280;--good:#1b5e20;--grid:#e0e0e0}
  [data-theme="dark"]{--bg:#0b0b0c;--card:#111214;--text:#e6eef8;--accent:#4a9eff;--muted:#9aa4b2;--good:#2e7d32;--grid:#333}
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,-apple-system,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;padding:10px 0}
  .phone{width:420px;max-width:100%;margin:0 auto;min-height:100vh;box-sizing:border-box;padding:14px}
  h2{margin:6px 0 12px;text-align:center;color:var(--accent)}
  .card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  input,select,button{font-family:inherit}
  input[type=text],select,input[type=time],input[type=number]{
    width:100%;padding:12px;margin:8px 0;border-radius:10px;border:1px solid #e6e9ee;background:transparent;color:var(--text);box-sizing:border-box
  }
  [data-theme="dark"] input,[data-theme="dark"] select{border-color:#333}
  input:focus,select:focus,button:focus{outline:3px solid var(--accent);outline-offset:2px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:12px 16px;border-radius:12px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
  .small{padding:9px 11px;border-radius:10px;background:#eee;border:none;cursor:pointer;font-size:14px}
  [data-theme="dark"] .small{background:#222;color:#eee}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px}
  #map{height:380px;border-radius:12px;overflow:hidden;margin-top:12px}
  #result{padding:14px;text-align:center;font-weight:700;font-size:15px}
  .fav-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(0,0,0,0.04);margin:6px 0}
  .mode-switch{display:flex;gap:8px;margin:12px 0 8px}
  .mode-switch button{flex:1;padding:12px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--accent);border-radius:12px}
  .mode-switch button.active{background:var(--accent);color:#fff}
  .chart-container{display:none;margin-top:12px}
  .sweet{background:#e8f5e9;border:2px solid var(--good);padding:12px;border-radius:12px;margin-top:12px;color:var(--good);font-weight:700;text-align:center;font-size:18px}
  .route-box{padding:10px;border-radius:10px;background:rgba(0,0,0,0.04);margin:8px 0;font-size:14px}
  .small-inline{display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.06);font-size:12px}
  @media(max-width:420px){.phone{padding:10px}}
</style>
</head>
<body data-theme="light">
<div class="phone">

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <h2>Korkometr PRO</h2>
    <button id="themeBtn" class="small">Dark mode</button>
  </div>

  <div class="card">
    <input id="startInput" type="text" placeholder="Skąd jedziesz? (zacznij pisać…)">
    <div class="row" style="margin:8px 0">
      <button id="geoBtn" class="small">Current location</button>
      <button id="swapBtn" class="small">Swap</button>
      <button id="saveFavBtn" class="small">Save favorite</button>
    </div>

    <input id="endInput" type="text" placeholder="Dokąd zmierzasz?">

    <div id="favoritesList" style="margin-top:12px"></div>

    <div class="muted" style="margin-top:12px">Tryb przewidywania korków:</div>
    <div class="row" style="gap:12px;flex-direction:column">
      <label><input type="radio" name="trafficModel" value="optimistic"> Optymistycznie</label>
      <label><input type="radio" name="trafficModel" value="best_guess" checked> Realistycznie</label>
      <label><input type="radio" name="trafficModel" value="pessimistic"> Pesymistycznie</label>
    </div>

    <div class="mode-switch">
      <button id="modeEarly" class="active">Najwcześniejszy dojazd</button>
      <button id="modeArrival">Dojazd do godziny X</button>
    </div>

    <div id="earlyMode">
      <div class="muted">Godziny analizy (jutro):</div>
      <div class="row">
        <input id="departFrom" type="time" value="06:30">
        <input id="departTo" type="time" value="09:30">
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <span class="muted">Krok:</span>
        <select id="stepSelect">
          <option value="5">5 min</option>
          <option value="10" selected>10 min</option>
          <option value="15">15 min</option>
        </select>
        <span class="muted" style="margin-left:12px">Tolerancja:</span>
        <input id="tolerance" type="number" value="2" min="0" max="15" style="width:70px">
      </div>
    </div>

    <div id="arrivalMode" style="display:none">
      <div class="muted">O której chcesz być na miejscu?</div>
      <div class="row">
        <input id="arrivalTime" type="time" value="18:00">
        <button id="nowBtn" class="small">Teraz +30 min</button>
      </div>
      <div class="muted" style="margin-top:8px">Okno poszukiwań przed tą godziną (minuty):</div>
      <input id="arrivalWindow" type="number" value="90" min="15" max="240" style="width:140px">
    </div>

    <div style="margin-top:12px">
      <label class="muted">Strategia objazdów:</label>
      <select id="detourLevel">
        <option value="none">bez objazdów</option>
        <option value="short" selected>małe objazdy (±20–30 km)</option>
        <option value="long">duże objazdy (±50–80 km)</option>
      </select>
    </div>

    <button id="bestTimeBtn" class="btn" style="margin-top:16px;width:100%">Oblicz najlepszą godzinę!</button>
  </div>

  <div id="result" class="card">Wypełnij pola i kliknij przycisk powyżej</div>

  <div id="sweetWindow" class="card" style="display:none">
    <div class="sweet" id="sweetText">Okienko</div>
  </div>

  <div id="map" class="card" style="padding:0"></div>

  <a id="googleMapsLink" class="btn" style="display:none;margin-top:12px;text-align:center;width:100%;text-decoration:none">
    Otwórz w Google Maps
  </a>

  <div id="chartArea" class="card chart-container">
    <canvas id="trafficChart"></canvas>
  </div>

  <div id="routes"></div>

</div>

<script>
/* =========================== GLOBALS =========================== */
let map, ds, dr, chart = null;
let allResults = [];
const sessionCache = new Map();
const darkMapStyles = [
  {elementType:"geometry",stylers:[{color:"#212121"}]},
  {elementType:"labels.icon",stylers:[{visibility:"off"}]},
  {elementType:"labels.text.fill",stylers:[{color:"#757575"}]},
  {elementType:"labels.text.stroke",stylers:[{color:"#212121"}]},
  {featureType:"road",elementType:"geometry",stylers:[{color:"#2c2c2c"}]},
  {featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#8a8a8a"}]}
];

/* =========================== INIT =========================== */
function init() {
  initMap();
  attachUI();
  loadFavorites();
  setupAutocomplete('startInput');
  setupAutocomplete('endInput');
  loadTheme();
}

/* =========================== THEME =========================== */
function loadTheme(){
  const saved = localStorage.getItem('kork_theme') || 'light';
  document.body.setAttribute('data-theme', saved);
  document.getElementById('themeBtn').textContent = saved === 'dark' ? 'Light mode' : 'Dark mode';
  updateMapStyle();
  if(chart) updateChartTheme();
}
document.getElementById('themeBtn').onclick = () => {
  const isDark = document.body.getAttribute('data-theme') === 'dark';
  const newTheme = isDark ? 'light' : 'dark';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('kork_theme', newTheme);
  document.getElementById('themeBtn').textContent = newTheme === 'dark' ? 'Light mode' : 'Dark mode';
  updateMapStyle();
  updateChartTheme();
};

/* =========================== MAP =========================== */
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat:52.2297, lng:21.0122},
    zoom: 11,
    gestureHandling: 'greedy',
    styles: document.body.getAttribute('data-theme') === 'dark' ? darkMapStyles : []
  });
  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({
    map,
    polylineOptions: {strokeColor:'#1565c0', strokeWeight:7},
    suppressMarkers: false
  });
}
function updateMapStyle(){
  const isDark = document.body.getAttribute('data-theme') === 'dark';
  map.setOptions({styles: isDark ? darkMapStyles : []});
  if(dr.getDirections()) dr.setMap(map); // odśwież polyline kolor
}

/* =========================== AUTOCOMPLETE =========================== */
function setupAutocomplete(id){
  const input = document.getElementById(id);
  const ac = new google.maps.places.Autocomplete(input, {
    componentRestrictions: {country:'pl'},
    fields: ['formatted_address','geometry','name']
  });
}

/* =========================== UI =========================== */
function attachUI(){
  document.getElementById('geoBtn').onclick = geoLocate;
  document.getElementById('swapBtn').onclick = swapInputs;
  document.getElementById('saveFavBtn').onclick = saveFavorite;
  document.getElementById('modeEarly').onclick = () => toggleMode('early');
  document.getElementById('modeArrival').onclick = () => toggleMode('arrival');
  document.getElementById('bestTimeBtn').onclick = findBestTime;
  document.getElementById('nowBtn').onclick = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() + 30);
    document.getElementById('arrivalTime').value = 
      `\( {String(d.getHours()).padStart(2,'0')}: \){String(d.getMinutes()).padStart(2,'0')}`;
  };
  toggleMode('early'); // default
}
function toggleMode(m){
  document.querySelectorAll('.mode-switch button').forEach(b=>b.classList.remove('active'));
  if(m==='early'){
    document.getElementById('earlyMode').style.display='block';
    document.getElementById('arrivalMode').style.display='none';
    document.getElementById('modeEarly').classList.add('active');
  }else{
    document.getElementById('earlyMode').style.display='none';
    document.getElementById('arrivalMode').style.display='block';
    document.getElementById('modeArrival').classList.add('active');
  }
}

/* =========================== FAVORITES =========================== */
function saveFavorite(){
  const s = document.getElementById('startInput').value.trim();
  const e = document.getElementById('endInput').value.trim();
  if(!s||!e) return alert('Wpisz start i cel');
  const key = s + ' → ' + e;
  let f = JSON.parse(localStorage.getItem('kfav')||'[]');
  if(!f.includes(key)){
    f.unshift(key);
    if(f.length>30) f.pop();
    localStorage.setItem('kfav',JSON.stringify(f));
  }
  loadFavorites();
}
function loadFavorites(){
  const list = JSON.parse(localStorage.getItem('kfav')||'[]');
  const div = document.getElementById('favoritesList');
  div.innerHTML = list.map(x=>`
    <div class="fav-item">
      <div style="flex:1;word-break:break-word">${x}</div>
      <div>
        <button class="small" onclick="loadFav('${x.replace(/'/g,"\\'")}')">Wczytaj</button>
        <button class="small" onclick="delFav('${x.replace(/'/g,"\\'")}')">Delete</button>
      </div>
    </div>`).join('');
}
function loadFav(t){
  const [a,b] = t.split(' → ');
  document.getElementById('startInput').value = a||'';
  document.getElementById('endInput').value = b||'';
}
function delFav(t){
  let f = JSON.parse(localStorage.getItem('kfav')||'[]');
  f = f.filter(x=>x!==t);
  localStorage.setItem('kfav',JSON.stringify(f));
  loadFavorites();
}

/* =========================== GEOLOCATION =========================== */
function geoLocate(){
  if(!navigator.geolocation) return alert('Geolokalizacja niedostępna');
  const btn = document.getElementById('geoBtn');
  const prev = btn.textContent;
  btn.textContent = '…';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const latlng = {lat:pos.coords.latitude, lng:pos.coords.longitude};
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({location:latlng}, (results,status)=>{
      if(status==='OK' && results[0]){
        document.getElementById('startInput').value = results[0].formatted_address;
        map.setCenter(latlng);
        map.setZoom(14);
      }else alert('Nie udało się ustalić adresu');
      btn.textContent = prev;
    });
  },()=>{ btn.textContent=prev; alert('Brak zgody'); });
}

/* =========================== SWAP =========================== */
function swapInputs(){
  const a = document.getElementById('startInput').value;
  const b = document.getElementById('endInput').value;
  document.getElementById('startInput').value = b;
  document.getElementById('endInput').value = a;
  clearMapAndResults();
}

/* =========================== CORE =========================== */
async function findBestTime(){
  clearMapAndResults();
  const start = document.getElementById('startInput').value.trim();
  const end = document.getElementById('endInput').value.trim();
  if(!start||!end) return alert('Podaj start i cel');

  document.getElementById('result').innerHTML = 'Analiza tras… (może potrwać 10–30 s)';
  document.getElementById('chartArea').style.display='none';
  if(chart){ chart.destroy(); chart=null; }

  const trafficModel = document.querySelector('input[name="trafficModel"]:checked').value;
  const detourLevel = document.getElementById('detourLevel').value;
  const tolerance = parseInt(document.getElementById('tolerance').value)||1;
  const step = parseInt(document.getElementById('stepSelect').value)||10;

  // jutro 00:00
  const base = new Date();
  base.setDate(base.getDate()+1);
  base.setHours(0,0,0,0);

  // czasy do sprawdzenia
  const times = [];
  const isArrivalMode = document.getElementById('arrivalMode').style.display!=='none';
  if(!isArrivalMode){
    const [h1,m1] = document.getElementById('departFrom').value.split(':').map(Number);
    const [h2,m2] = document.getElementById('departTo').value.split(':').map(Number);
    let cur = new Date(base);
    cur.setHours(h1,m1);
    const endT = new Date(base);
    endT.setHours(h2,m2);
    while(cur<=endT){
      times.push(new Date(cur));
      cur = new Date(cur.getTime() + step*60000);
    }
  }else{
    const [ah,am] = document.getElementById('arrivalTime').value.split(':').map(Number);
    const win = parseInt(document.getElementById('arrivalWindow').value)||60;
    const arrival = new Date(base);
    arrival.setHours(ah,am);
    let cur = new Date(arrival.getTime() - win*60000);
    while(cur<=arrival){
      times.push(new Date(cur));
      cur = new Date(cur.getTime() + step*60000);
    }
  }

  allResults = [];
  const startLoc = await geocode(start);
  const endLoc = await geocode(end);
  if(!startLoc||!endLoc){ alert('Błąd geokodowania'); return; }

  const detourWaypoints = detourLevel==='none' ? [] : makeDetourWaypoints(startLoc, detourLevel);

  for(const t of times){
    // główna trasa
    await throttle(400);
    const main = await getRoutes(start, end, t, trafficModel);
    main.forEach(r=>allResults.push({depart:t, dur:Math.round(r.eta/60), dist:r.distance, obj:r.raw}));

    // objazdy
    if(detourWaypoints.length){
      for(const wp of detourWaypoints){
        await throttle(400);
        const alt = await getRoutes(start, end, t, trafficModel, wp);
        alt.forEach(r=>allResults.push({depart:t, dur:Math.round(r.eta/60), dist:r.distance, obj:r.raw}));
      }
    }
  }

  if(!allResults.length){ document.getElementById('result').innerHTML='Brak danych'; return; }

  const minDur = Math.min(...allResults.map(x=>x.dur));
  const p10 = percentile(allResults.map(x=>x.dur),10);
  const sweet = allResults.filter(r=> r.dur <= minDur + tolerance || r.dur <= p10 + tolerance);
  sweet.sort((a,b)=> a.dur - b.dur || a.depart - b.depart);
  const winner = sweet.length ? sweet[0] : allResults.sort((a,b)=>a.dur-b.dur)[0];

  // wynik główny
  document.getElementById('result').innerHTML = `
    Najlepszy wyjazd: <span style="font-size:22px;color:var(--good)">${fmt(winner.depart)}</span><br>
    \( {winner.dur} min • \){(winner.dist/1000).toFixed(1)} km
  `;
  document.getElementById('sweetText').textContent = sweet.length 
    ? `\( {fmt(sweet[0].depart)} – \){fmt(sweet[sweet.length-1].depart)}`
    : fmt(winner.depart);
  document.getElementById('sweetWindow').style.display='block';

  dr.setDirections(winner.obj);
  map.fitBounds(boundsFromResult(winner.obj));

  // link do Maps
  document.getElementById('googleMapsLink').href = 
    `https://www.google.com/maps/dir/?api=1&origin=\( {encodeURIComponent(start)}&destination= \){encodeURIComponent(end)}&travelmode=driving&departure_time=${Math.round(winner.depart.getTime()/1000)}`;
  document.getElementById('googleMapsLink').style.display='block';

  drawChart();
  showAlternatives();
}

/* =========================== HELPERS =========================== */
async function throttle(ms=400){ // bezpieczne 2–3 zapytania/sek
  await new Promise(r=>setTimeout(r,ms));
}
function fmt(d){ return d.toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'}); }
function percentile(arr,p){
  const s=arr.slice().sort((a,b)=>a-b);
  return s[Math.floor(p/100*(s.length-1))];
}
async function geocode(addr){
  const key='g:'+addr;
  const cached=localStorage.getItem(key);
  if(cached) return JSON.parse(cached);
  const res = await new Promise(r=>{
    new google.maps.Geocoder().geocode({address:addr, region:'pl'},(res,st)=>r({res,st}));
  });
  if(res.st!=='OK') return null;
  const loc = res.res[0].geometry.location;
  const obj={lat:loc.lat(),lng:loc.lng()};
  localStorage.setItem(key,JSON.stringify(obj));
  return obj;
}
function makeDetourWaypoints({lat,lng},level){
  if(level==='none') return [];
  const d = level==='short'?0.22:0.5;
  return [
    {lat:lat+d,lng},{lat:lat-d,lng},
    {lat,lng:lng+d},{lat,lng:lng-d}
  ];
}
async function getRoutes(o,d,departTime,model='best_guess',waypoint=null){
  const cacheKey=`r:\( {o}| \){d}|\( {departTime.toISOString()}| \){model}|${waypoint?JSON.stringify(waypoint):''}`;
  if(sessionCache.has(cacheKey)) return sessionCache.get(cacheKey);
  const res = await new Promise(resolve=>{
    const req={
      origin:o,destination:d,travelMode:'DRIVING',
      provideRouteAlternatives:true,
      drivingOptions:{departureTime:departTime,trafficModel:model}
    };
    if(waypoint) req.waypoints=[{location:waypoint,stopover:false}];
    ds.route(req,(result,status)=>{
      if(status!=='OK') return resolve([]);
      const out = result.routes.map(rt=>({
        eta: rt.legs[0].duration_in_traffic ? rt.legs[0].duration_in_traffic.value : rt.legs[0].duration.value,
        distance: rt.legs[0].distance.value,
        raw: result
      }));
      resolve(out);
    });
  });
  sessionCache.set(cacheKey,res);
  return res;
}
function boundsFromResult(res){
  const b = new google.maps.LatLngBounds();
  res.routes[0].overview_path.forEach(p=>b.extend(p));
  return b;
}
function drawChart(){
  const grouped = {};
  allResults.forEach(r=>{
    const k = r.depart.toISOString();
    if(!grouped[k] || grouped[k].dur > r.dur) grouped[k]=r;
  });
  const data = Object.values(grouped).sort((a,b)=>a.depart-b.depart);
  const labels = data.map(x=>fmt(x.depart));
  const values = data.map(x=>x.dur);

  document.getElementById('chartArea').style.display='block';
  if(chart) chart.destroy();
  const ctx = document.getElementById('trafficChart').getContext('2d');
  chart = new Chart(ctx,{
    type:'line',data:{labels,datasets:[{
      label:'Czas jazdy (min)',data:values,
      tension:0.3,fill:true,backgroundColor:'rgba(21,101,192,0.1)',
      borderColor:'#1565c0',pointRadius:5
    }]},
    options:{
      responsive:true,plugins:{legend:{display:false}},
      onClick:(e,els)=>{ if(els.length) showRouteFromChart(els[0].index); },
      scales:{x:{ticks:{color:'var(--text)'},grid:{color:'var(--grid)'}},
              y:{ticks:{color:'var(--text)'},grid:{color:'var(--grid)'}}}
    }
  });
  updateChartTheme();
}
function updateChartTheme(){
  if(!chart) return;
  const dark = document.body.getAttribute('data-theme')==='dark';
  chart.options.scales.x.ticks.color = dark?'#e6eef8':'#111';
  chart.options.scales.y.ticks.color = dark?'#e6eef8':'#111';
  chart.options.scales.x.grid.color = 'var(--grid)';
  chart.options.scales.y.grid.color = 'var(--grid)';
  chart.data.datasets[0].borderColor = dark?'#7bb3ff':'#1565c0';
  chart.data.datasets[0].backgroundColor = dark?'rgba(123,179,255,0.15)':'rgba(21,101,192,0.1)';
  chart.update();
}
function showRouteFromChart(idx){
  const data = Object.values(/*grouped from drawChart*/);
  const r = data[idx];
  if(r && r.obj){
    dr.setDirections(r.obj);
    map.fitBounds(boundsFromResult(r.obj));
  }
}
function showAlternatives(){
  const uniq = {};
  allResults.forEach(r=>{ const k=r.depart.toISOString()+':'+r.dur; if(!uniq[k]) uniq[k]=r; });
  const top = Object.values(uniq).sort((a,b)=>a.dur-b.dur).slice(0,8);
  window._top = top; // na potrzeby kliknięć
  let html = '<div style="margin-top:16px"><b>Top alternatywy:</b>';
  top.forEach((r,i)=> {
    html+=`<div class="route-box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>\( {fmt(r.depart)}</b> → \){r.dur} min <span class="small-inline">${(r.dist/1000).toFixed(1)} km</span></div>
        <button class="small" onclick="dr.setDirections(window._top[\( {i}].obj);map.fitBounds(boundsFromResult(window._top[ \){i}].obj))">Pokaż</button>
      </div>
    </div>`;
  });
  html+='</div>';
  document.getElementById('routes').innerHTML = html;
}
function clearMapAndResults(){
  dr.setDirections({routes:[]});
  document.getElementById('result').innerHTML='Wypełnij pola…';
  document.getElementById('sweetWindow').style.display='none';
  document.getElementById('chartArea').style.display='none';
  document.getElementById('routes').innerHTML='';
  document.getElementById('googleMapsLink').style.display='none';
  if(chart){chart.destroy();chart=null;}
  allResults=[];
}
</script>
</body>
</html>