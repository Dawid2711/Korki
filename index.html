<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Korkometr ‚Äî TEST</title>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk&libraries=places"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #f8f9fa;
        color: #222;
    }
    body[data-theme="dark"] {
        background: #111;
        color: #eee;
    }
    header {
        padding: 16px;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        background: #333;
        color: white;
    }
    body[data-theme="dark"] header {
        background: #000;
    }
    .container {
        padding: 16px;
        max-width: 900px;
        margin: auto;
    }
    .row { margin-bottom: 14px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input, select, button {
        padding: 12px;
        width: 100%;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        background: white;
        color: #222;
    }
    body[data-theme="dark"] input,
    body[data-theme="dark"] select {
        background: #222;
        color: #eee;
        border-color: #444;
    }
    button {
        background: #0078ff;
        color: white;
        cursor: pointer;
        margin-top: 6px;
    }
    button:hover { opacity: 0.85; }

    #map {
        width: 100%;
        height: 350px;
        margin-top: 15px;
        border-radius: 10px;
    }

    #chartContainer {
        margin-top: 25px;
    }

    .fav-box {
        background: rgba(0,0,0,0.05);
        padding: 8px;
        border-radius: 8px;
    }
    body[data-theme="dark"] .fav-box {
        background: rgba(255,255,255,0.08);
    }
    .fav-item {
        padding: 6px 0;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #ccc3;
    }
    .deleteFav { cursor: pointer; color: red; }
</style>
</head>

<body data-theme="light">

<header>Korkometr ‚Äî wersja testowa</header>

<div class="container">

    <button onclick="toggleTheme()">üåô Tryb ciemny / jasny</button>

    <div class="row">
        <label>Start</label>
        <input id="start" placeholder="Wpisz adres">
        <button onclick="useGeo('start')">U≈ºyj mojej lokalizacji</button>
    </div>

    <div class="row">
        <label>Koniec</label>
        <input id="end" placeholder="Wpisz adres">
        <button onclick="useGeo('end')">U≈ºyj mojej lokalizacji</button>
    </div>

    <button onclick="swapPoints()">‚ÜîÔ∏è Zamie≈Ñ punkty</button>

    <div class="row">
        <label>Tryb analizy</label>
        <select id="mode">
            <option value="departure">Chcƒô wyjechaƒá jak najszybciej</option>
            <option value="arrival">Chcƒô byƒá na miejscu o‚Ä¶</option>
        </select>
    </div>

    <div class="row">
        <label>Godzina</label>
        <input id="time" type="time">
    </div>

    <div class="row">
        <label>Tolerancja sweet spot (minuty)</label>
        <input id="tol" type="number" value="2" min="0" max="10">
    </div>

    <button onclick="runAnalysis()">üîç Analizuj</button>

    <div id="map"></div>

    <div id="chartContainer">
        <canvas id="chart"></canvas>
    </div>

    <button onclick="saveFav()">‚≠ê Dodaj do ulubionych</button>

    <h3>Ulubione</h3>
    <div class="fav-box" id="favList"></div>

</div>

<script>
/* -------------------- THEME ----------------------- */
function toggleTheme() {
    const dark = document.body.dataset.theme === "dark";
    document.body.dataset.theme = dark ? "light" : "dark";
    updateChartTheme();
}

/* -------------------- MAP ------------------------- */
let map, directionsService, directionsRenderer;

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 12,
        center: { lat: 52.2297, lng: 21.0122 }
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });
}

window.onload = () => {
    initMap();
    favRender();
    setupAutocomplete("start");
    setupAutocomplete("end");
};

/* -------------------- AUTOCOMPLETE ------------------ */
function setupAutocomplete(id) {
    new google.maps.places.Autocomplete(document.getElementById(id), {
        fields: ["geometry", "formatted_address"],
    });
}

/* -------------------- GEO --------------------------- */
function useGeo(id) {
    navigator.geolocation.getCurrentPosition(
        pos => {
            const latlng = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            };

            new google.maps.Geocoder().geocode({ location: latlng }, (res, status) => {
                if (status === "OK" && res[0]) {
                    document.getElementById(id).value = res[0].formatted_address;
                }
            });
        },
        () => alert("Nie pozwoli≈Çe≈õ na lokalizacjƒô")
    );
}

/* -------------------- SWAP --------------------------- */
function swapPoints() {
    const a = document.getElementById("start").value;
    const b = document.getElementById("end").value;
    document.getElementById("start").value = b;
    document.getElementById("end").value = a;
    directionsRenderer.set("directions", null);
}

/* -------------------- FAVORITES --------------------- */
function saveFav() {
    const s = document.getElementById("start").value;
    const e = document.getElementById("end").value;
    if (!s || !e) return alert("Wpisz oba adresy");

    const list = JSON.parse(localStorage.getItem("fav") || "[]");
    list.push({ s, e });
    localStorage.setItem("fav", JSON.stringify(list));
    favRender();
}

function favRender() {
    const box = document.getElementById("favList");
    const list = JSON.parse(localStorage.getItem("fav") || "[]");
    box.innerHTML = "";
    list.forEach((x, i) => {
        box.innerHTML += `
            <div class="fav-item">
                ${x.s} ‚Üí ${x.e}
                <span class="deleteFav" onclick="favDel(${i})">‚ùå</span>
            </div>`;
    });
}

function favDel(i) {
    const list = JSON.parse(localStorage.getItem("fav") || "[]");
    list.splice(i, 1);
    localStorage.setItem("fav", JSON.stringify(list));
    favRender();
}

/* -------------------- CHART ------------------------- */
let chart;

function updateChartTheme() {
    if (!chart) return;
    const dark = document.body.dataset.theme === "dark";
    chart.options.scales.x.ticks.color = dark ? "#eee" : "#222";
    chart.options.scales.y.ticks.color = dark ? "#eee" : "#222";
    chart.update();
}

/* -------------------- API WRAPPER (throttle) -------- */
let lastRequestTime = 0;

function throttleDelay() {
    const now = Date.now();
    const diff = now - lastRequestTime;
    if (diff < 200) {
        return new Promise(res => setTimeout(res, 200 - diff));
    }
    return Promise.resolve();
}

/* -------------------- GET DURATION -------------------- */
async function getDuration(start, end, time) {
    await throttleDelay();
    lastRequestTime = Date.now();

    return new Promise((resolve) => {
        directionsService.route({
            origin: start,
            destination: end,
            travelMode: "DRIVING",
            drivingOptions: {
                departureTime: new Date(time)
            }
        }, (res, status) => {
            if (status === "OK") {
                resolve(res.routes[0].legs[0].duration_in_traffic.value);
            } else {
                resolve(null);
            }
        })
    });
}

/* -------------------- ANALYSIS ------------------------ */
async function runAnalysis() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    if (!start || !end) return alert("Wpisz oba adresy");

    const mode = document.getElementById("mode").value;
    const timeStr = document.getElementById("time").value;
    const tol = parseInt(document.getElementById("tol").value);

    let baseTime = new Date();
    if (timeStr) {
        const [h, m] = timeStr.split(":");
        baseTime.setHours(h, m, 0, 0);
    }

    const times = [];
    const durations = [];

    let from, to;

    if (mode === "departure") {
        from = new Date(baseTime.getTime());
        to = new Date(baseTime.getTime() + 60 * 60 * 1000);
    } else {
        from = new Date(baseTime.getTime() - 60 * 60 * 1000);
        to = new Date(baseTime.getTime());
    }

    let t = new Date(from);
    while (t <= to) {
        const d = await getDuration(start, end, t);
        if (d !== null) {
            times.push(new Date(t));
            durations.push(d / 60);
        }
        t = new Date(t.getTime() + 5 * 60000);
    }

    plot(times, durations);

    const min = Math.min(...durations);
    const sweet = durations.map(x => x <= min + tol);

    const bestIndex = sweet.indexOf(true);
    if (bestIndex >= 0) {
        directionsService.route({
            origin: start,
            destination: end,
            travelMode: "DRIVING",
            drivingOptions: { departureTime: times[bestIndex] }
        }, (res, s) => {
            if (s === "OK") directionsRenderer.setDirections(res);
        });
    }
}

/* -------------------- Chart rendering ------------------- */
function plot(times, dur) {
    const ctx = document.getElementById("chart");

    const labels = times.map(t => t.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }));

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Czas przejazdu (min)",
                data: dur,
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { ticks: { color: document.body.dataset.theme === "dark" ? "#eee" : "#222" }},
                y: { ticks: { color: document.body.dataset.theme === "dark" ? "#eee" : "#222" }}
            }
        }
    });
}

</script>

</body>
</html>