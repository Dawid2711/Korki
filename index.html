<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Korkometr PRO 2025</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Google Maps – z callbackiem, żeby nie było szarej mapy -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk&libraries=places&callback=initMaps"></script>

<style>
  :root {
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #0f172a;
    --text-muted: #64748b;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --good: #16a34a;
    --border: #e2e8f0;
    --shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
  }
  [data-theme="dark"] {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --accent: #60a5fa;
    --accent-hover: #3b82f6;
    --good: #22c55e;
    --border: #334155;
    --shadow: 0 10px 25px -5px rgba(0,0,0,0.4);
  }

  * { box-sizing: border-box; margin:0; padding:0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 12px 0;
    transition: background 0.3s;
  }
  .app {
    max-width: 460px;
    margin: 0 auto;
    padding: 0 16px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  h1 {
    font-size: 26px;
    font-weight: 800;
    background: linear-gradient(90deg, var(--accent), #a78bfa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .card {
    background: var(--card);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: all 0.3s;
  }
  input, select, button {
    font-family: inherit;
    font-size: 16px;
    border-radius: 14px;
  }
  input[type=text], input[type=time], input[type=number], select {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: var(--text);
    margin: 8px 0;
  }
  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
  }
  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .btn {
    padding: 14px 20px;
    border: none;
    border-radius: 14px;
    background: var(--accent);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
  .btn-small {
    padding: 10px 14px;
    font-size: 14px;
    background: #e2e8f0;
    color: #334155;
  }
  [data-theme="dark"] .btn-small { background: #334155; color: #e2e8f0; }
  .mode-tabs {
    display: flex;
    background: rgba(0,0,0,0.05);
    border-radius: 14px;
    overflow: hidden;
    margin: 16px 0;
  }
  .mode-tabs button {
    flex: 1;
    padding: 14px;
    background: transparent;
    border: none;
    font-weight: inherit;
    color: var(--text-muted);
    font-weight: 600;
  }
  .mode-tabs button.active {
    background: var(--accent);
    color: white;
  }
  #map { height: 360px; border-radius: 18px; overflow: hidden; margin: 16px 0; }
  .result {
    text-align: center;
    font-size: 20px;
    font-weight: 700;
    line-height: 1.4;
  }
  .sweet {
    background: linear-gradient(135deg, #dcfce7, #bbf7ee);
    color: var(--good);
    padding: 16px;
    border-radius: 16px;
    text-align: center;
    font-size: 22px;
    font-weight: 800;
    margin: 16px 0;
    border: 2px solid var(--good);
  }
  .fav-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(0,0,0,0.04);
    border-radius: 12px;
    margin: 6px 0;
    font-size: 15px;
  }
  .route-box {
    background: rgba(59,130,246,0.08);
    border: 1px solid rgba(59,130,246,0.2);
    border-radius: 12px;
    padding: 12px;
    margin: 8px 0;
  }
</style>
</head>
<body data-theme="light">

<div class="app">

  <header>
    <h1>Korkometr PRO</h1>
    <button id="themeBtn" class="btn-small">Dark mode</button>
  </header>

  <div class="card">
    <input id="startInput" type="text" placeholder="Skąd jedziesz?">
    <div class="row">
      <button id="geoBtn" class="btn-small">Current location</button>
      <button id="swapBtn" class="btn-small">Swap</button>
      <button id="saveFavBtn" class="btn-small">Save favorite</button>
    </div>

    <input id="endInput" type="text" placeholder="Dokąd jedziesz?">

    <div id="favoritesList" style="margin-top:12px"></div>

    <div style="margin:16px 0 8px; color:var(--text-muted); font-size:14px">Prognoza korków</div>
    <div class="row">
      <label><input type="radio" name="model" value="optimistic"> Optymistycznie</label>
      <label><input type="radio" name="model" value="best_guess" checked> Realistycznie</label>
      <label><input type="radio" name="model" value="pessimistic"> Pesymistycznie</label>
    </div>

    <div class="mode-tabs">
      <button id="modeEarly" class="active">Najwcześniejszy dojazd</button>
      <button id="modeArrival">Dojazd do godziny</button>
    </div>

    <div id="earlyMode">
      <div style="color:var(--text-muted);margin-bottom:8px">Zakres godzin jutro</div>
      <div class="row">
        <input type="time" id="fromTime" value="06:00">
        <input type="time" id="toTime" value="09:30">
      </div>
      <div class="row" style="margin-top:12px;align-items:center">
        <span style="color:var(--text-muted)">Krok</span>
        <select id="step">
          <option value="5">5 min</option>
          <option value="10" selected>10 min</option>
          <option value="15">15 min</option>
        </select>
        <span style="color:var(--text-muted);margin-left:16px">Tolerancja</span>
        <input type="number" id="tolerance" value="3" min="0" max="10" style="width:70px">
      </div>
    </div>

    <div id="arrivalMode" style="display:none">
      <div style="color:var(--text-muted);margin-bottom:8px">Chcę być na miejscu o</div>
      <div class="row">
        <input type="time" id="targetTime" value="18:00">
        <button id="nowPlus30" class="btn-small">Teraz +30 min</button>
      </div>
      <div style="color:var(--text-muted);margin-top:12px">Szukaj wcześniej o (min)</div>
      <input type="number" id="window" value="90" min="30" max="240">
    </div>

    <div style="margin-top:16px">
      <div style="color:var(--text-muted);margin-bottom:8px">Objazdy</div>
      <select id="detours">
        <option value="none">Bez objazdów</option>
        <option value="short" selected>Małe objazdy</option>
        <option value="long">Duże objazdy</option>
      </select>
    </div>

    <button id="calcBtn" class="btn" style="width:100%;margin-top:20px;font-size:18px;padding:16px">
      Oblicz najlepszą godzinę
    </button>
  </div>

  <div id="result" class="card" style="text-align:center;padding:30px;color:var(--text-muted)">
    Wpisz trasę i kliknij przycisk
  </div>

  <div id="sweetSpot" class="card" style="display:none"></div>

  <div id="map" class="card"></div>

  <a id="openMaps" class="btn" style="display:none;width:100%;text-align:center;margin-top:12px;text-decoration:none">
    Otwórz w Google Maps
  </a>

  <div id="chartCard" class="card" style="display:none">
    <canvas id="chart"></canvas>
  </div>

  <div id="alts"></div>

</div>

<script>
let map, ds, dr, chart = null;
const cache = new Map();

const darkMapStyle = [{elementType:"geometry",stylers:[{color:"#0f172a"}]},{elementType:"labels.text.fill",stylers:[{color:"#94a3b8"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#1e293b"}]}];

function initMaps() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat:52.2297,lng:21.0122}, zoom: 11,
    gestureHandling: 'greedy',
    styles: document.body.dataset.theme === 'dark' ? darkMapStyle : []
  });
  ds = new google.maps.DirectionsService();
  dr = new google.maps.DirectionsRenderer({map, suppressMarkers: false, polylineOptions:{strokeColor:'#3b82f6',strokeWeight:8}});
  attachEvents();
  loadTheme();
  loadFavs();
}

function attachEvents() {
  document.getElementById('themeBtn').onclick = () => {
    const dark = document.body.dataset.theme === 'dark';
    document.body.dataset.theme = dark ? 'light' : 'dark';
    localStorage.korkTheme = document.body.dataset.theme;
    document.getElementById('themeBtn').textContent = dark ? 'Dark mode' : 'Light mode';
    map.setOptions({styles: dark ? [] : darkMapStyle});
    if(chart) chart.update();
  };

  document.getElementById('geoBtn').onclick = getLocation;
  document.getElementById('swapBtn').onclick = () => { const a=document.getElementById('startInput').value; document.getElementById('startInput').value=document.getElementById('endInput').value; document.getElementById('endInput').value=a; clearAll(); };
  document.getElementById('saveFavBtn').onclick = saveFav;
  document.getElementById('modeEarly').onclick = () => switchMode('early');
  document.getElementById('modeArrival').onclick = () => switchMode('arrival');
  document.getElementById('calcBtn').onclick = calculate;
  document.getElementById('nowPlus30').onclick = () => {
    const d = new Date.now() + 30*60*1000;
    const date = new Date(d);
    document.getElementById('targetTime').value = date.toTimeString().slice(0,5);
  };
  new google.maps.places.Autocomplete(document.getElementById('startInput'), {componentRestrictions:{country:'pl'}});
  new google.maps.places.Autocomplete(document.getElementById('endInput'), {componentRestrictions:{country:'pl'}});
}

function switchMode(m){
  ['modeEarly','modeArrival'].forEach(id=>document.getElementById(id).classList.toggle('active',false));
  document.getElementById('mode'+(m==='early'?'Early':'Arrival')).classList.add('active');
  document.getElementById('earlyMode').style.display = m==='early'?'block':'none';
  document.getElementById('arrivalMode').style.display = m==='arrival'?'block':'none';
}

function getLocation(){
  if(!navigator.geolocation) return alert('Geolokalizacja niedostępna');
  const b = document.getElementById('geoBtn');
  b.textContent='…';
  navigator.geolocation.getCurrentPosition(p=>{
    const pos = {lat:p.coords.latitude, lng:p.coords.longitude};
    new google.maps.Geocoder().geocode({location:pos}, (r,s)=>{
      if(s==='OK') document.getElementById('startInput').value = r[0].formatted_address;
      map.setCenter(pos); map.setZoom(15);
      b.textContent='Current location';
    });
  },()=>b.textContent='Current location');
}

function loadTheme(){
  const t = localStorage.korkTheme || 'light';
  document.body.dataset.theme = t;
  document.getElementById('themeBtn').textContent = t==='dark'?'Light mode':'Dark mode';
}

function saveFav(){
  const [a,b] = [document.getElementById('startInput').value, document.getElementById('endInput').value];
  if(!a||!b) return alert('Uzupełnij trasę');
  const key = a+' → '+b;
  let f = JSON.parse(localStorage.kfav||'[]');
  if(!f.includes(key)) { f.unshift(key); f=f.slice(0,20); localStorage.kfav=JSON.stringify(f); }
  loadFavs();
}
function loadFavs(){
  const list = JSON.parse(localStorage.kfav||'[]');
  document.getElementById('favoritesList').innerHTML = list.map(x=>`
    <div class="fav-item">
      <span>${x}</span>
      <div>
        <button class="btn-small" onclick="loadFav('${x}')">Wczytaj</button>
        <button class="btn-small" onclick="delFav('${x}')">Delete</button>
      </div>
    </div>`).join('');
}
function loadFav(t){ const [a,b]=t.split(' → '); document.getElementById('startInput').value=a; document.getElementById('endInput').value=b; }
function delFav(t){ let f=JSON.parse(localStorage.kfav||'[]'); f=f.filter(x=>x!==t); localStorage.kfav=JSON.stringify(f); loadFavs(); }

async function calculate(){
  clearAll();
  const origin = document.getElementById('startInput').value.trim();
  const dest = document.getElementById('endInput').value.trim();
  if(!origin||!dest) return alert('Podaj obie lokalizacje');

  document.getElementById('result').innerHTML = 'Trwa analiza tras…';

  const model = document.querySelector('[name=model]:checked').value;
  const detours = document.getElementById('detours').value;
  const step = +document.getElementById('step').value * 60000;
  const tol = +document.getElementById('tolerance').value;

  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1); tomorrow.setHours(0,0,0,0);

  let times = [];
  if(document.getElementById('earlyMode').style.display!=='none'){
    const [h1,m1] = document.getElementById('fromTime').value.split(':');
    const [h2,m2] = document.getElementById('toTime').value.split(':');
    let cur = new Date(tomorrow); cur.setHours(+h1,+m1);
    const end = new Date(tomorrow; end.setHours(+h2,+m2);
    while(cur<=end){ times.push(new Date(cur)); cur = new Date(cur.getTime()+step); }
  }else{
    const [h,m] = document.getElementById('targetTime').value.split(':');
    const target = new Date(tomorrow); target.setHours(+h,+m);
    const win = +document.getElementById('window').value * 60000;
    let cur = new Date(target.getTime() - win);
    while(cur<=target){ times.push(new Date(cur)); cur=new Date(cur.getTime()+step); }
  }

  let results = [];

  const oLoc = await geo(origin);
  const dLoc = await geo(dest);
  if(!oLoc || !dLoc) { document.getElementById('result').innerHTML='Błąd lokalizacji'; return; }

  const waypoints = detours==='none'?[]: [
    {lat:oLoc.lat+0.25,lng:oLoc.lng},
    {lat:oLoc.lat-0.25,lng:oLoc.lng},
    {lat:oLoc.lat,lng:oLoc.lng+0.25},
    {lat:oLoc.lat,lng:oLoc.lng-0.25},
    ...(detours==='long'?[{lat:oLoc.lat+0.5,lng:oLoc.lng},{lat:oLoc.lat-0.5,lng:oLoc.lng}] : [])
  ];

  for(const t of times){
    await new Promise(r=>setTimeout(r, 420)); // bezpieczny limit Google

    const main = await requestRoute(origin,dest,t,model);
    main.forEach(r=>results.push({t, dur:Math.round(r.eta/60), dist:r.dist, obj:r.raw}));

    if(waypoints.length)for(const wp of waypoints){
      await new Promise(r=>setTimeout(r,420));
      const alt = await requestRoute(origin,dest,t,model,wp);
      alt.forEach(r=>results.push({t, dur:Math.round(r.eta/60), dist:r.dist, obj:r.raw}));
    }
  }

  if(!results.length){ document.getElementById('result').innerHTML='Brak danych'; return; }

  const min = Math.min(...results.map(r=>r.dur));
  const sweet = results.filter(r=>r.dur <= min + tol);
  sweet.sort((a,b)=>a.dur-b.dur || a.t-b.t);
  const best = sweet[0] || results[0];

  document.getElementById('result').innerHTML = `
    <div style="font-size:28px;color:var(--good);margin:10px 0">${best.t.toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'})}</div>
    \( {best.dur} min • \){(best.dist/1000).toFixed(1)} km
  `;
  document.getElementById('sweetSpot').innerHTML = `<div class="sweet">${sweet.map(r=>r.t.toLocaleTimeString().slice(0,5)).join(' – ')}</div>`;
  document.getElementById('sweetSpot').style.display='block';

  dr.setDirections(best.obj);
  map.fitBounds(best.obj.routes[0].bounds);

  document.getElementById('openMaps').href = `https://www.google.com/maps/dir/?api=1&origin=\( {encodeURIComponent(origin)}&destination= \){encodeURIComponent(dest)}&travelmode=driving`;
  document.getElementById('openMaps').style.display='block';

  drawChart(results);
  showTopAlts(results);
}

async function geo(addr){
  const key = 'g'+addr;
  if(cache.has(key)) return cache.get(key);
  const saved = localStorage.getItem(key);
  if(saved) { cache.set(key,JSON.parse(saved)); return cache.get(key); }
  return new Promise(res=>{
    new google.maps.Geocoder().geocode({address:addr,region:'pl'},(r,s)=>{
      if(s!=='OK' || !r[0]) return res(null);
      const loc = r[0].geometry.location;
      const obj = {lat:loc.lat(),lng:loc.lng()};
      localStorage.setItem(key,JSON.stringify(obj));
      cache.set(key,obj);
      res(obj);
    });
  });
}

async function requestRoute(o,d,t,model,wp=null){
  const key = `r\( {o} \){d}\( {t.toISOString()} \){model}${wp?'w'+wp.lat+wp.lng:''}`;
  if(cache.has(key)) return cache.get(key);
  return new Promise(res=>{
    const req = {origin:o,destination:d,travelMode:'DRIVING',provideRouteAlternatives:true,drivingOptions:{departureTime:t,trafficModel:model}};
    if(wp) req.waypoints = [{location:wp,stopover:false}];
    ds.route(req,(result,status)=>{
      if(status!=='OK') return res([]);
      const out = result.routes.map(rt=>({
        eta: rt.legs[0].duration_in_traffic?.value || rt.legs[0].duration.value,
        dist: rt.legs[0].distance.value,
        raw: result
      }));
      cache.set(key,out);
      res(out);
    });
  });
}

function drawChart(data){
  const byTime = {};
  data.forEach(r=>{ const k=r.t.toISOString(); if(!byTime[k]||byTime[k].dur>r.dur) byTime[k]=r; });
  const sorted = Object.values(byTime).sort((a,b)=>a.t-b.t);
  const labels = sorted.map(r=>r.t.toTimeString().slice(0,5));
  const values = sorted.map(r=>r.dur);

  document.getElementById('chartCard').style.display='block';
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'),{
    type:'line', data:{labels,datasets:[{data:values,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',tension:0.3,fill:true,pointRadius:5}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'var(--text-muted)'}},y:{ticks:{color:'var(--text-muted)'}}}}
  });
}

function showTopAlts(data){
  const uniq = {}; data.forEach(r=>{const k=r.t.toISOString()+r.dur; if(!uniq[k]) uniq[k]=r;});
  const top = Object.values(uniq).sort((a,b)=>a.dur-b.dur).slice(0,7);
  document.getElementById('alts').innerHTML = '<div style="margin-top:20px"><b>Top alternatywy</b>'+top.map(r=>`
    <div class="route-box">
      <b>\( {r.t.toTimeString().slice(0,5)}</b> → \){r.dur} min <small>${(r.dist/1000).toFixed(1)} km</small>
      <button class="btn-small" style="float:right" onclick="dr.setDirections(this.closest('.route-box').dataObj);map.fitBounds(this.closest('.route-box').dataObj.routes[0].bounds)">Pokaż</button>
    </div>`).join('')+'</div>';
  top.forEach((r,i)=>document.querySelectorAll('.route-box')[i].dataObj = r.obj);
}

function clearAll(){
  dr.setDirections({routes:[]});
  document.getElementById('result').innerHTML='Wpisz trasę…';
  document.getElementById('sweetSpot').style.display='none';
  document.getElementById('chartCard').style.display='none';
  document.getElementById('alts').innerHTML='';
  document.getElementById('openMaps').style.display='none';
  if(chart){chart.destroy();chart=null;}
}
</script>
</body>
</html>