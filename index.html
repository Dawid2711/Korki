<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Korkometr PRO – Test App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #121212;
        color: #fff;
        display: flex;
        justify-content: center;
    }

    /* Telefonowy viewport */
    .app-phone {
        width: 420px;
        max-width: 100%;
        min-height: 100vh;
        background: #1b1b1b;
        padding: 16px;
        box-sizing: border-box;
    }

    h1 {
        text-align: center;
        font-size: 22px;
        margin-bottom: 12px;
    }

    .card {
        background: #222;
        padding: 14px;
        border-radius: 14px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    label {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 6px;
        display: block;
    }

    input {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: none;
        background: #333;
        color: #fff;
        font-size: 16px;
        margin-bottom: 10px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #4f7df0;
        border: none;
        border-radius: 14px;
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        margin-top: 10px;
        cursor: pointer;
    }

    #map {
        width: 100%;
        height: 420px;
        border-radius: 14px;
        overflow: hidden;
        margin-top: 16px;
    }

    .route-box {
        background: #282828;
        padding: 12px;
        border-radius: 12px;
        margin-top: 10px;
        border-left: 4px solid #4f7df0;
    }
</style>
</head>

<body>

<div class="app-phone">
    <h1>Korkometr PRO – Test</h1>

    <div class="card">
        <label>Start:</label>
        <input id="start" placeholder="np. Warszawa, Centrum">

        <label>Cel:</label>
        <input id="end" placeholder="np. Kraków">

        <button onclick="calculateRoutes()">Wyznacz trasę</button>
    </div>

    <div id="routes"></div>

    <div id="map"></div>
</div>


<script>
let map;
let polylines = [];

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: { lat: 52.0, lng: 19.0 },
        styles: [
            { elementType: "geometry", stylers: [{ color: "#1d1d1d" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#1d1d1d" }] }
        ]
    });
}

/* Tworzy punkty objazdowe 20–50 km */
function generateWaypoints(lat, lng) {
    const d = 0.25; // około 25–30 km
    return [
        { location: { lat: lat + d, lng: lng }, stopover: false },
        { location: { lat: lat - d, lng: lng }, stopover: false },
        { location: { lat: lat, lng: lng + d }, stopover: false },
        { location: { lat: lat, lng: lng - d }, stopover: false },
    ];
}

async function calculateRoutes() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;

    if (!start || !end) {
        alert("Wpisz start i cel.");
        return;
    }

    clearMap();

    const geocoder = new google.maps.Geocoder();

    const startCoords = await geocoder.geocode({ address: start });
    const endCoords = await geocoder.geocode({ address: end });

    const s = startCoords.results[0].geometry.location;
    const e = endCoords.results[0].geometry.location;

    const waypoints = generateWaypoints(s.lat(), s.lng());

    let allRoutes = [];

    for (const wp of [...waypoints, null]) {
        const part = await requestRoutes(s, e, wp);
        allRoutes.push(...part);
    }

    // Sortowanie najkrótszego ETA
    allRoutes.sort((a, b) => a.eta - b.eta);

    drawRoutes(allRoutes);
    showRouteBoxes(allRoutes);
}

function requestRoutes(start, end, waypoint) {
    return new Promise((resolve) => {
        const ds = new google.maps.DirectionsService();

        ds.route(
            {
                origin: start,
                destination: end,
                waypoints: waypoint ? [waypoint] : [],
                travelMode: "DRIVING",
                provideRouteAlternatives: true,
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: "best_guess"
                }
            },
            (result, status) => {
                if (status !== "OK") {
                    resolve([]);
                    return;
                }

                const routes = result.routes.map(r => {
                    const legs = r.legs[0];
                    return {
                        poly: r.overview_path,
                        distance: legs.distance.value,
                        duration: legs.duration.value,
                        traffic: legs.duration_in_traffic
                            ? legs.duration_in_traffic.value
                            : legs.duration.value,
                        eta: legs.duration_in_traffic
                            ? legs.duration_in_traffic.value
                            : legs.duration.value,
                        summary: r.summary
                    };
                });

                resolve(routes);
            }
        );
    });
}

function drawRoutes(routes) {
    routes.forEach((r, i) => {
        const line = new google.maps.Polyline({
            path: r.poly,
            map,
            strokeColor: i === 0 ? "#4f7df0" : "#555",
            strokeWeight: i === 0 ? 7 : 5,
            strokeOpacity: i === 0 ? 1 : 0.6
        });
        polylines.push(line);
    });
}

function clearMap() {
    polylines.forEach(p => p.setMap(null));
    polylines = [];
}

function showRouteBoxes(routes) {
    const div = document.getElementById("routes");
    div.innerHTML = "";

    routes.forEach((r, i) => {
        const minutes = Math.round(r.eta / 60);
        const km = (r.distance / 1000).toFixed(1);

        div.innerHTML += `
            <div class="route-box" style="border-left-color:${i===0?'#4f7df0':'#444'}">
                <b>${i === 0 ? "NAJSZYBSZA TRASA" : "Trasa alternatywna"}</b><br>
                ETA: ${minutes} min<br>
                Dystans: ${km} km<br>
                Droga: ${r.summary || "brak danych"}
            </div>
        `;
    });
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk&callback=initMap">
</script>

</body>
</html>