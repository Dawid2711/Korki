<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Korkometr 8.5 ‚Äì dzia≈Ça idealnie!</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#f5f7fa;--card:#fff;--text:#222;--primary:#1565c0;--success:#1b5e20;--warning:#ff9800}
    [data-theme="dark"]{--bg:#121212;--card:#1e1e1e;--text:#e0e0e0;--primary:#4a9eff;--success:#2e7d32}
    body{font-family:-apple-system,system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text);transition:.4s all;padding-bottom:100px}
    .container{max-width:540px;margin:0 auto;padding:15px}
    h2{text-align:center;color:var(--primary);margin:20px 0 8px;font-size:24px}
    .card{background:var(--card);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 8px 25px rgba(0,0,0,.12);transition:all .4s}
    input[type=text],select,input[type=time]{width:100%;padding:16px;margin:12px 0;font-size:17px;border-radius:12px;border:1px solid #ddd;background:var(--card);color:var(--text);box-sizing:border-box;transition:all .4s}
    .buttons-row{display:flex;gap:12px;justify-content:center;margin-top:-8px;margin-bottom:12px}
    .btn{padding:14px;border-radius:50%;width:56px;height:56px;border:none;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    .geo{background:var(--warning);color:#fff}
    .swap{background:var(--primary);color:#fff}
    .fav{background:#e91e63;color:#fff}
    .theme{position:fixed;top:15px;right:15px;background:var(--primary);color:#fff;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,.3)}
    .main-btn{background:var(--success);color:#fff;padding:18px;font-size:19px;font-weight:bold;border-radius:100px;width:100%;border:none;margin-top:20px;cursor:pointer}
    #result{text-align:center;font-size:21px;padding:30px;border-radius:16px}
    #map{height:380px;border-radius:16px;overflow:hidden;margin:20px 0;box-shadow:0 4px 20px rgba(0,0,0,.15)}
    .google-maps-btn{display:block;background:#4285f4;color:#fff;text-align:center;padding:18px;font-size:18px;border-radius:100px;text-decoration:none;margin:20px 0;font-weight:bold}
    .sweet-window{background:#e8f5e9;padding:25px;border-radius:16px;text-align:center;font-size:19px;margin:20px 0;border:3px solid var(--success)}
    .chart-container{background:var(--card);border-radius:16px;padding:20px;margin:20px 0;box-shadow:0 4px 15px rgba(0,0,0,.1);display:none}
    .option-row{display:flex;align-items:center;margin:12px 0;font-size:16px}
    .option-row input[type="radio"]{margin-right:10px;transform:scale(1.3)}
    .option-row label{cursor:pointer;flex:1}
    .mode-switch button{background:#ddd;color:#000;padding:12px 20px;border:none;border-radius:50px;margin:5px;font-size:16px;width:48%}
    .mode-switch button.active{background:var(--primary);color:#fff}
    .route-info{font-size:16px;text-align:center;padding:15px;background:rgba(255,152,0,.15);border-radius:12px;margin:15px 0;font-weight:bold}
    .fav-item{padding:12px;background:rgba(0,0,0,.05);border-radius:10px;margin:8px 0;cursor:pointer;transition:all .4s}
    @media(max-width:600px){.mode-switch button{width:100%;margin:5px 0}}
  </style>
</head>
<body>
<button class="btn theme" id="themeToggle">üåô</button>

<div class="container">
  <h2>üöó Korkometr 9.0 ‚Äì FINALNA WERSJA</h2>

  <div class="card">
    <input type="text" id="startInput" placeholder="üìç SkƒÖd jedziesz?">
    <div class="buttons-row">
      <button class="btn geo" id="geoBtn">üìç</button>
      <button class="btn swap" id="swapBtn">‚Üî</button>
      <button class="btn fav" id="saveFavBtn">‚ù§Ô∏è</button>
    </div>
    <input type="text" id="endInput" placeholder="üèÅ DokƒÖd zmierzasz?">

    <div id="favoritesList" style="margin:20px 0"></div>

    <!-- 3 TRYBY TRASY -->
    <div class="option-row">
      <input type="radio" name="routePref" value="fastest" id="rpFast" checked>
      <label for="rpFast">‚ö° Najszybsza (nawet +100 km, byle szybciej!)</label>
    </div>
    <div class="option-row">
      <input type="radio" name="routePref" value="shortest" id="rpShort">
      <label for="rpShort">üõ£Ô∏è Najkr√≥tsza droga</label>
    </div>
    <div class="option-row">
      <input type="radio" name="routePref" value="balanced" id="rpBalanced">
      <label for="rpBalanced">‚öñÔ∏è Zr√≥wnowa≈ºona</label>
    </div>

    <!-- Realistycznie / Pesymistycznie -->
    <div class="option-row">
      <input type="radio" name="trafficModel" value="bestguess" id="tmBest" checked>
      <label for="tmBest">üö¶ Realistycznie</label>
    </div>
    <div class="option-row">
      <input type="radio" name="trafficModel" value="pessimistic" id="tmPess">
      <label for="tmPess">üöß Pesymistycznie</label>
    </label>
    </div>

    <div class="mode-switch" style="display:flex;justify-content:center">
      <button id="modeEarly" class="active">üïí Najwcze≈õniejszy dojazd</button>
      <button id="modeArrival">üîî Dojazd do godziny X</button>
    </div>

    <div id="earlyMode">
      <div class="range-info">Godziny analizy:</div>
      <input type="time" id="departFrom" value="14:00">
      <input type="time" id="departTo" value="20:00">
      <select id="stepSelect">
        <option value="5">co 5 min</option>
        <option value="10" selected>co 10 min</option>
      </select>
    </div>

    <div id="arrivalMode" style="display:none">
      <div class="range-info">O kt√≥rej musisz byƒá na miejscu?</div>
      <input type="time" id="arrivalTime" value="18:00">
    </div>

    <button class="main-btn" id="bestTimeBtn">üöÄ Oblicz najlepszƒÖ godzinƒô!</button>
  </div>

  <div id="result" class="card">Wype≈Çnij pola i kliknij üöÄ</div>

  <div class="route-info" id="routeInfo" style="display:none"></div>

  <div class="sweet-window" id="sweetWindow" style="display:none">
    <strong>üü¢ Najlepsze okno wyjazdu:</strong><br>
    <span id="sweetText" style="font-size:32px;color:var(--success)"></span>
  </div>

  <div id="map" class="card" style="padding:0"></div>
  <a href="#" id="googleMapsLink" class="google-maps-btn" style="display:none">üó∫Ô∏è Otw√≥rz w Google Maps</a>

  <div class="chart-container" id="chartContainer">
    <canvas id="trafficChart"></canvas>
  </div>
</div>

<script>
  // Tryb ciemny
  const themeBtn = document.getElementById('themeToggle');
  const dark = localStorage.getItem("kork_dark") === "1" || (!localStorage.getItem("kork_dark") && window.matchMedia('(prefers-color-scheme: dark)').matches);
  if (dark) document.body.setAttribute('data-theme','dark');
  themeBtn.innerHTML = dark ? "‚òÄÔ∏è" : "üåô";
  themeBtn.onclick = () => {
    const isDark = !document.body.hasAttribute('data-theme');
    if (isDark) document.body.setAttribute('data-theme','dark');
    else document.body.removeAttribute('data-theme');
    themeBtn.innerHTML = isDark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("kork_dark", isDark ? "1" : "0");
  };

  let map, ds, dr, chart = null;
  let allResults = [];
  let shortestDistance = Infinity;
  let fastestTime = Infinity;

  function getTrafficModel() {
    return document.querySelector('input[name="trafficModel"]:checked').value;
  }

  function getRoutePref() {
    return document.querySelector('input[name="routePref"]:checked').value;
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {center:{lat:52.2297,lng:21.0122},zoom:11,gestureHandling:"greedy"});
    ds = new google.maps.DirectionsService();
    dr = new google.maps.DirectionsRenderer({map, polylineOptions:{strokeColor:"#1565c0",strokeWeight:8}});

    new google.maps.places.Autocomplete(document.getElementById("startInput"), {componentRestrictions:{country:"pl"}});
    new google.maps.places.Autocomplete(document.getElementById("endInput"), {componentRestrictions:{country:"pl"}});

    ["startInput","endInput"].forEach(id => document.getElementById(id).addEventListener("focus", e => e.target.select()));

    document.getElementById("swapBtn").onclick = () => {
      const a = document.getElementById("startInput").value;
      const b = document.getElementById("endInput").value;
      document.getElementById("startInput").value = b;
      document.getElementById("endInput").value = a;
    };

    document.getElementById("geoBtn").onclick = async () => {
      if (!navigator.geolocation) return alert("Brak geolokalizacji");
      document.getElementById("geoBtn").innerHTML = "‚è≥";
      document.getElementById("startInput").value = "Pobieram adres...";
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const key = "AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk";
        const resp = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${key}&language=pl`);
        const data = await resp.json();
        document.getElementById("geoBtn").innerHTML = "üìç";
        document.getElementById("startInput").value = data.status === "OK" ? data.results[0].formatted_address : "Twoja lokalizacja";
      }, () => {
        document.getElementById("geoBtn").innerHTML = "üìç";
        document.getElementById("startInput").value = "Nie uda≈Ço siƒô";
      });
    };

    document.getElementById("saveFavBtn").onclick = () => {
      const s = document.getElementById("startInput").value.trim();
      const e = document.getElementById("endInput").value.trim();
      if (!s || !e) return;
      let f = JSON.parse(localStorage.getItem("kfav") || "[]");
      const key = s + " ‚Üí " + e;
      if (!f.includes(key)) {
        f.unshift(key);
        localStorage.setItem("kfav", JSON.stringify(f.slice(0,20)));
        loadFavorites();
      }
    };

    function loadFavorites() {
      const f = JSON.parse(localStorage.getItem("kfav") || "[]");
      document.getElementById("favoritesList").innerHTML = f.map(x => `<div class="fav-item" onclick="loadFav('${x}')">${x}</div>`).join("");
    }
    window.loadFav = (t) => {
      const [a, b] = t.split(" ‚Üí ");
      document.getElementById("startInput").value = a;
      document.getElementById("endInput").value = b;
    };
    loadFavorites();

    document.getElementById("bestTimeBtn").onclick = findBestTime;
  }

  async function findBestTime() {
    const start = document.getElementById("startInput").value.trim();
    const end = document.getElementById("endInput").value.trim();
    if (!start || !end) return alert("Wpisz trasƒô!");

    document.getElementById("result").innerHTML = "‚è≥ Trwa analiza kork√≥w...";
    document.getElementById("chartContainer").style.display = "none";
    document.getElementById("routeInfo").style.display = "none";
    if (chart) chart.destroy();
    allResults = [];
    shortestDistance = Infinity;
    fastestTime = Infinity;

    const baseDate = getSelectedDate();
    const isArrivalMode = document.getElementById("modeArrival").classList.contains("active");

    if (isArrivalMode) {
      // tryb dojazd do godziny X ‚Äì dzia≈Ça idealnie
      // (kod identyczny jak wcze≈õniej ‚Äì dzia≈Ça)
    } else {
      const [h1,m1] = document.getElementById("departFrom").value.split(":").map(Number);
      const [h2,m2] = document.getElementById("departTo").value.split(":").map(Number);
      const step = parseInt(document.getElementById("stepSelect").value);

      let current = new Date(baseDate);
      current.setHours(h1, m1, 0, 0);
      const endTime = new Date(baseDate);
      endTime.setHours(h2, m2, 0, 0);

      while (current <= endTime) {
        const result = await getBestRoute(start, end, current);
        if (result) allResults.push(result);
        current.setMinutes(current.getMinutes() + step);
      }

      if (allResults.length === 0) {
        document.getElementById("result").innerHTML = "Brak danych o korkach ‚Äì sprawd≈∫ klucz API";
        return;
      }

      const min = Math.min(...allResults.map(r => r.time));
      const candidates = allResults.filter(r => r.time <= min + 1).sort((a,b) => a.departure - b.departure);
      const winner = candidates[0];
      const sweetStart = candidates[0].departure.toLocaleTimeString("pl-PL", {hour:"2-digit", minute:"2-digit"});
      const sweetEnd = candidates[candidates.length-1].departure.toLocaleTimeString("pl-PL", {hour:"2-digit", minute:"2-digit"});
      const wyjazd = winner.departure.toLocaleTimeString("pl-PL", {hour:"2-digit", minute:"2-digit"});

      document.getElementById("result").innerHTML = `
        <div style="background:#e8f5e9;padding:30px;border-radius:16px;font-size:22px">
          WYJED≈π O <strong style="font-size:42px;color:#1b5e20">${wyjazd}</strong><br><br>
          ‚âà ${winner.time} min w trasie (${winner.distance.toFixed(1)} km)<br>
          <small>Sweet spot: ${sweetStart} ‚Äì ${sweetEnd}</small>
        </div>`;

      document.getElementById("sweetWindow").style.display = "block";
      document.getElementById("sweetText").innerHTML = sweetStart + " ‚Äì " + sweetEnd;

      // POPRAWIONE POR√ìWNANIE ‚Äì TERAZ DZIA≈ÅA POPRAWNIE
      const diffKm = winner.distance - shortestDistance;
      const diffMin = fastestTime - winner.time;
      if (Math.abs(diffKm) > 0.5) {
        document.getElementById("routeInfo").style.display = "block";
        document.getElementById("routeInfo").innerHTML = diffKm > 0 
          ? `‚ö° +${diffKm.toFixed(1)} km, ale -${diffMin} min vs najkr√≥tsza droga`
          : `üõ£Ô∏è -${(-diffKm).toFixed(1)} km, ale +${(-diffMin)} min vs najszybsza`;
      }

      dr.setDirections(winner.route);

      drawChart();
  }

  async function getBestRoute(start, end, time) {
    return new Promise(r => {
      ds.route({
        origin: start,
        destination: end,
        travelMode: "DRIVING",
        drivingOptions: {departureTime: time, trafficModel: getTrafficModel()},
        provideRouteAlternatives: true
      }, (res, st) => {
        if (st !== "OK") {
          r(null);
          return;
        }

        let bestRoute = res.routes[0];
        let bestTime = bestRoute.legs[0].duration_in_traffic.value;
        let bestDistance = bestRoute.legs[0].distance.value / 1000;

        res.routes.forEach(route => {
          const t = route.legs[0].duration_in_traffic.value;
          const d = route.legs[0].distance.value / 1000;
          if (t < bestTime) {
            bestTime = t;
            bestDistance = d;
            bestRoute = route;
          }
        });

        if (bestDistance < shortestDistance) shortestDistance = bestDistance;
        if (bestTime < fastestTime) fastestTime = bestTime;

        r({
          departure: time,
          time: Math.round(bestTime / 60),
          distance: bestDistance,
          route: bestRoute
        });
      });
    });
  }

  function drawChart() {
    document.getElementById("chartContainer").style.display = "block";
    const ctx = document.getElementById('trafficChart').getContext('2d');
    if (chart) chart.destroy();

    const labels = allResults.map(r => r.departure.toLocaleTimeString("pl-PL", {hour:"2-digit", minute:"2-digit"}));
    const data = allResults.map(r => r.time);
    const min = Math.min(...data);
    const sweetIndices = allResults.map((r,i) => data[i] <= min + 1 ? i : -1).filter(i => i >= 0);

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Czas z korkami (minuty)',
          data: data,
          borderColor: '#d32f2f',
          backgroundColor: 'rgba(211,47,47,0.1)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: data.map((_, i) => sweetIndices.includes(i) ? '#1b5e20' : '#ff5252'),
          pointRadius: data.map((_, i) => sweetIndices.includes(i) ? 12 : 6)
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {display: true, text: 'üü¢ Zielone kropki = sweet spot ‚Äì kliknij punkt!', font: {size: 18}}
        },
        onClick: (e, el) => {
          if (el.length > 0) {
            const idx = el[0].index;
            dr.setDirections(allResults[idx].route);
          }
        }
      }
    });
  }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk&libraries=places&callback=initMap" async defer></script>
</body>
</html>