<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Korkometr 7.0 – działa idealnie!</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{--bg:#f5f7fa;--card:#fff;--text:#222;--primary:#1565c0;--success:#1b5e20;--warning:#ff9800;--border:#e0e0e0}
    [data-theme="dark"]{--bg:#121212;--card:#1e1e1e;--text:#e0e0e0;--primary:#4a9eff;--success:#2e7d32;--border:#333}
    body{font-family:-apple-system,system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text);transition:.4s all;padding-bottom:100px}
    .container{max-width:540px;margin:0 auto;padding:15px}
    h2{text-align:center;color:var(--primary);margin:20px 0 8px;font-size:26px;font-weight:800;background:linear-gradient(90deg,var(--primary),#7e57c2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .card{background:var(--card);border-radius:18px;padding:22px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.12);border:1px solid var(--border);transition:all .4s}
    input[type=text],select,input[type=time],input[type=date]{width:100%;padding:16px;margin:10px 0;font-size:17px;border-radius:14px;border:1.5px solid var(--border);background:var(--card);color:var(--text);box-sizing:border-box;transition:all .3s}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 12px rgba(21,101,192,.25)}
    .buttons-row{display:flex;gap:14px;justify-content:center;margin:8px 0 16px}
    .btn{padding:0;width:56px;height:56px;border-radius:50%;border:none;font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(0,0,0,.22);transition:.3s}
    .geo{background:#fb8c00;color:#fff}
    .swap{background:var(--primary);color:#fff}
    .fav{background:#e91e63;color:#fff}
    .theme{position:fixed;top:16px;right:16px;background:var(--primary);color:#fff;z-index:1000;box-shadow:0 6px 20px rgba(0,0,0,.3);width:52px;height:52px;font-size:24px}
    .main-btn{background:var(--success);color:#fff;padding:20px;font-size:20px;font-weight:900;border-radius:100px;width:100%;border:none;margin-top:24px;cursor:pointer;box-shadow:0 8px 20px rgba(27,94,32,.3);transition:.3s}
    .main-btn:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(27,94,32,.4)}
    #result{text-align:center;font-size:22px;padding:32px;border-radius:18px;background:rgba(27,94,32,.08)}
    #map{height:380px;border-radius:18px;overflow:hidden;margin:20px 0;box-shadow:0 8px 30px rgba(0,0,0,.18)}
    .google-maps-btn{display:block;background:#4285f4;color:#fff;text-align:center;padding:18px;font-size:18px;border-radius:100px;text-decoration:none;margin:20px 0;font-weight:bold;box-shadow:0 6px 18px rgba(66,133,244,.4)}
    .sweet-window{background:linear-gradient(135deg,#e8f5e9,#d4edda);padding:28px;border-radius:18px;text-align:center;font-size:20px;margin:20px 0;border:3px solid var(--success);font-weight:800;color:var(--success)}
    .chart-container{background:var(--card);border-radius:18px;padding:20px;margin:20px 0;box-shadow:0 6px 20px rgba(0,0,0,.1);display:none}
    .option-row{display:flex;align-items:center;margin:14px 0;font-size:16px}
    .option-row input[type="radio"]{margin-right:12px;transform:scale(1.4);accent-color:var(--primary)}
    .option-row label{cursor:pointer;flex:1;font-weight:500}
    .mode-switch{display:flex;gap:12px;margin:20px 0}
    .mode-switch button{flex:1;padding:16px;border:none;border-radius:50px;background:#e0e0e0;color:#000;font-weight:600;font-size:16px;transition:.3s}
    .mode-switch button.active{background:var(--primary);color:#fff;transform:scale(1.03);box-shadow:0 6px 16px rgba(21,101,192,.3)}
    .fav-item{padding:16px;background:rgba(0,0,0,.06);border-radius:14px;margin:10px 0;cursor:pointer;transition:.3s;font-weight:500}
    .fav-item:hover{background:rgba(0,0,0,.12);transform:translateY(-2px)}
    .info{margin:10px 0;color:var(--text);opacity:.8;font-size:14px;text-align:center}
    @media(max-width:500px){.mode-switch{flex-direction:column} .mode-switch button{margin:6px 0}}
  </style>
</head>
<body data-theme="light">

<button class="btn theme" id="themeToggle">Dark mode</button>

<div class="container">
  <h2>Korkometr 7.0</h2>
  <div class="info">Najlepsza godzina wyjazdu z korkami w czasie rzeczywistym</div>

  <div class="card">
    <input type="text" id="startInput" placeholder="Skąd jedziesz?">
    <div class="buttons-row">
      <button class="btn geo" id="geoBtn" title="Bieżąca lokalizacja">Current location</button>
      <button class="btn swap" id="swapBtn" title="Zamień">Swap</button>
      <button class="btn fav" id="saveFavBtn" title="Zapisz ulubioną">Save favorite</button>
    </div>
    <input type="text" id="endInput" placeholder="Dokąd zmierzasz?">

    <div id="favoritesList" style="margin:20px 0"></div>

    <!-- Dzień -->
    <div style="margin:20px 0 10px;font-weight:600;color:var(--primary)">Kiedy jedziesz?</div>
    <div class="option-row"><input type="radio" name="day" value="today" id="d1" checked><label for="d1">Dziś</label></div>
    <div class="option-row"><input type="radio" name="day" value="tomorrow" id="d2"><label for="d2">Jutro</label></div>
    <div class="option-row"><input type="radio" name="day" value="custom" id="d3"><label for="d3">Inny dzień → <input type="date" id="customDate" style="width:auto;padding:8px;margin-left:8px"></label></div>

    <!-- Model korków -->
    <div style="margin:20px 0 10px;font-weight:600;color:var(--primary)">Prognoza korków</div>
    <div class="option-row"><input type="radio" name="trafficModel" value="best_guess" checked><label>Realistycznie (zalecane)</label></div>
    <div class="option-row"><input type="radio" name="trafficModel" value="pessimistic"><label>Pesymistycznie (bezpieczniej)</label></div>

    <!-- Tryb -->
    <div class="mode-switch">
      <button id="modeEarly" class="active">Najwcześniejszy dojazd</button>
      <button id="modeArrival">Dojazd do godziny X</button>
    </div>

    <div id="earlyMode">
      <div style="margin:16px 0 8px;font-weight:600;color:var(--primary)">Analiza od-do</div>
      <input type="time" id="departFrom" value="06:00">
      <input type="time" id="departTo" value="09:30">
      <select id="stepSelect" style="margin-top:12px">
        <option value="5">co 5 minut</option>
        <option value="10" selected>co 10 minut</option>
        <option value="15">co 15 minut</option>
      </select>
    </div>

    <div id="arrivalMode" style="display:none">
      <div style="margin:16px 0 8px;font-weight:600;color:var(--primary)">O której musisz być na miejscu?</div>
      <div style="display:flex;gap:12px;align-items:center">
        <input type="time" id="arrivalTime" value="18:00">
        <button id="nowPlus30" style="padding:10px 16px;border-radius:12px;border:none;background:#eee;font-size:14px">Teraz +30 min</button>
      </div>
      <div style="margin-top:12px;color:var(--text);opacity:.8">Szukaj wyjazdów wcześniej o max <input type="number" id="window" value="90" min="30" max="240" style="width:80px"> minut</div>
    </div>

    <button class="main-btn" id="bestTimeBtn">Oblicz najlepszą godzinę!</button>
  </div>

  <div id="result" class="card">Wypełnij pola i kliknij przycisk powyżej</div>

  <div class="sweet-window" id="sweetWindow" style="display:none">
    <strong>Najlepsze okno wyjazdu:</strong><br>
    <span id="sweetText" style="font-size:36px"></span>
  </div>

  <div id="map" class="card" style="padding:0"></div>
  <a href="#" id="googleMapsLink" class="google-maps-btn" style="display:none">Otwórz w Google Maps</a>

  <div class="chart-container" id="chartContainer">
    <canvas id="trafficChart"></canvas>
  </div>
</div>

<script>
  // === TEMA ===
  const themeBtn = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('kork_theme');
  if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.setAttribute('data-theme','dark');
    themeBtn.textContent = 'Light mode';
  } else {
    themeBtn.textContent = 'Dark mode';
  }
  themeBtn.onclick = () => {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    themeBtn.textContent = isDark ? 'Dark mode' : 'Light mode';
    localStorage.setItem('kork_theme', isDark ? 'light' : 'dark');
  };

  let map, ds, dr, chart = null;
  let allResults = [];
  const cache = new Map();

  // === DATA ===
  function getSelectedDate() {
    const choice = document.querySelector('input[name="day"]:checked').value;
    const today = new Date();
    today.setHours(0,0,0,0);
    if (choice === 'today') return today;
    if (choice === 'tomorrow') { today.setDate(today.getDate()+1); return today; }
    const custom = document.getElementById('customDate').value;
    return custom ? new Date(custom) : new Date(Date.now() + 86400000);
  }

  // === MAPA ===
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat:52.2297, lng:21.0122}, zoom: 11,
      gestureHandling: 'greedy',
      styles: document.body.getAttribute('data-theme') === 'dark' ? [
        {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
        {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
        {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]}
      ] : []
    });
    ds = new google.maps.DirectionsService();
    dr = new google.maps.DirectionsRenderer({map, suppressMarkers: false, polylineOptions:{strokeColor:'#1565c0',strokeWeight:8}});

    // Autouzupełnianie
    ['startInput','endInput'].forEach(id => {
      new google.maps.places.Autocomplete(document.getElementById(id), {componentRestrictions:{country:'pl'}});
    });

    // UI
    document.getElementById('geoBtn').onclick = getLocation;
    document.getElementById('swapBtn').onclick = () => {
      const a = document.getElementById('startInput').value;
      document.getElementById('startInput').value = document.getElementById('endInput').value;
      document.getElementById('endInput').value = a;
      clearResults();
    };
    document.getElementById('saveFavBtn').onclick = saveFavorite;
    document.getElementById('modeEarly').onclick = () => switchMode('early');
    document.getElementById('modeArrival').onclick = () => switchMode('arrival');
    document.getElementById('nowPlus30').onclick = () => {
      const d = new Date();
      d.setMinutes(d.getMinutes() + 30);
      document.getElementById('arrivalTime').value = d.toTimeString().slice(0,5);
    };
    document.getElementById('bestTimeBtn').onclick = calculate;

    loadFavorites();
    switchMode('early');
  }

  function switchMode(mode){
    document.querySelectorAll('.mode-switch button').forEach(b=>b.classList.remove('active'));
    document.getElementById('mode'+(mode==='early'?'Early':'Arrival')).classList.add('active');
    document.getElementById('earlyMode').style.display = mode==='early'?'block':'none';
    document.getElementById('arrivalMode').style.display = mode==='arrival'?'block':'none';
  }

  // === GEOLOKALIZACJA (BEZ KLUCZA W Kodzie) ===
  function getLocation(){
    if(!navigator.geolocation) return alert('Geolokalizacja niedostępna');
    const btn = document.getElementById('geoBtn');
    btn.textContent = 'Loading...';
    navigator.geolocation.getCurrentPosition(async pos => {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({location:{lat:pos.coords.latitude,lng:pos.coords.longitude}}, (results,status)=>{
        if(status==='OK' && results[0]){
          document.getElementById('startInput').value = results[0].formatted_address;
          map.setCenter({lat:pos.coords.latitude,lng:pos.coords.longitude});
          map.setZoom(15);
        }
        btn.textContent = 'Current location';
      });
    }, ()=>{ btn.textContent = 'Current location'; });
  }

  // === ULUBIONE ===
  function saveFavorite(){
    const a = document.getElementById('startInput').value.trim();
    const b = document.getElementById('endInput').value.trim();
    if(!a||!b) return alert('Uzupełnij trasę');
    const key = a+' → '+b;
    let f = JSON.parse(localStorage.getItem('kfav')||'[]');
    if(!f.includes(key)){
      f.unshift(key);
      if(f.length>30) f.pop();
      localStorage.setItem('kfav',JSON.stringify(f));
      loadFavorites();
    }
  }
  function loadFavorites(){
    const f = JSON.parse(localStorage.getItem('kfav')||'[]');
    document.getElementById('favoritesList').innerHTML = f.map(x=>`
      <div class="fav-item" onclick="loadFav('\( {x.replace(/'/g,\\'')}')"> \){x}</div>
    `).join('');
  }
  function loadFav(t){
    const [a,b] = t.split(' → ');
    document.getElementById('startInput').value = a;
    document.getElementById('endInput').value = b;
  }

  // === GŁÓWNA FUNKCJA ===
  async function calculate(){
    clearResults();
    const origin = document.getElementById('startInput').value.trim();
    const dest = document.getElementById('endInput').value.trim();
    if(!origin||!dest) return alert('Wpisz start i cel');

    document.getElementById('result').innerHTML = 'Analiza setek tras… (10–40 s)';
    document.getElementById('chartContainer').style.display='none';
    if(chart) chart.destroy();

    const baseDate = getSelectedDate();
    const model = document.querySelector('input[name="trafficModel"]:checked').value;
    const isArrival = document.getElementById('arrivalMode').style.display !== 'none';

    let times = [];
    if(!isArrival){
      const [h1,m1] = document.getElementById('departFrom').value.split(':').map(Number);
      const [h2,m2] = document.getElementById('departTo').value.split(':').map(Number);
      const step = parseInt(document.getElementById('stepSelect').value) * 60000;
      let cur = new Date(baseDate);
      cur.setHours(h1,m1);
      const endT = new Date(baseDate);
      endT.setHours(h2,m2);
      while(cur <= endT){
        times.push(new Date(cur));
        cur = new Date(cur.getTime() + step);
      }
    }else{
      const [h,m] = document.getElementById('arrivalTime').value.split(':').map(Number);
      const win = parseInt(document.getElementById('window').value) * 60000;
      const target = new Date(baseDate);
      target.setHours(h,m);
      let cur = new Date(target.getTime() - win);
      const step = 10*60000;
      while(cur <= target){
        times.push(new Date(cur));
        cur = new Date(cur.getTime() + step);
      }
    }

    allResults = [];

    for(const t of times){
      await new Promise(r => setTimeout(r, 380)); // bezpieczny limit Google

      const routes = await getRoutes(origin, dest, t, model);
      routes.forEach(r => {
        allResults.push({
          time: t,
          dur: Math.round(r.eta/60),
          dist: r.dist,
          obj: r.raw
        });
      });
    }

    if(allResults.length===0){
      document.getElementById('result').innerHTML = 'Brak danych – sprawdź połączenie lub klucz API';
      return;
    }

    const minDur = Math.min(...allResults.map(x=>x.dur));
    const sweet = allResults.filter(x=>x.dur <= minDur + 2);
    sweet.sort((a,b)=>a.time-b.time);
    const best = sweet[0];

    const fmt = t => t.toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
    const sweetText = sweet.length > 1 ? `\( {fmt(sweet[0].time)} – \){fmt(sweet[sweet.length-1].time)}` : fmt(best.time);

    document.getElementById('result').innerHTML = `
      <div style="font-size:28px">WYJEDŹ O</div>
      <div style="font-size:48px;font-weight:900;color:var(--success);margin:16px 0">${fmt(best.time)}</div>
      <div>\( {best.dur} minut • \){(best.dist/1000).toFixed(1)} km</div>
    `;

    document.getElementById('sweetText').textContent = sweetText;
    document.getElementById('sweetWindow').style.display = 'block';

    dr.setDirections(best.obj);
    map.fitBounds(best.obj.routes[0].bounds);

    document.getElementById('googleMapsLink').style.display = 'block';
    document.getElementById('googleMapsLink').href = `https://www.google.com/maps/dir/?api=1&origin=\( {encodeURIComponent(origin)}&destination= \){encodeURIComponent(dest)}&travelmode=driving`;

    drawChart();
  }

  async function getRoutes(o,d,t,model){
    const key = `r:\( {o}| \){d}|\( {t.toISOString()}| \){model}`;
    if(cache.has(key)) return cache.get(key);

    return new Promise(resolve=>{
      const req = {
        origin:o, destination:d, travelMode:'DRIVING',
        provideRouteAlternatives:true,
        drivingOptions:{departureTime:t, trafficModel:model}
      };
      ds.route(req, (res,status)=>{
        if(status!=='OK') return resolve([]);
        const out = res.routes.map(rt=>({
          eta: rt.legs[0].duration_in_traffic?.value || rt.legs[0].duration.value,
          dist: rt.legs[0].distance.value,
          raw: res
        }));
        cache.set(key, out);
        resolve(out);
      });
    });
  }

  function drawChart(){
    document.getElementById('chartContainer').style.display='block';
    const grouped = {};
    allResults.forEach(r=>{
      const k = r.time.toISOString();
      if(!grouped[k] || grouped[k].dur > r.dur) grouped[k] = r;
    });
    const sorted = Object.values(grouped).sort((a,b)=>a.time-b.time);

    const labels = sorted.map(r=>r.time.toTimeString().slice(0,5));
    const data = sorted.map(r=>r.dur);
    const min = Math.min(...data);
    const sweetIdx = data.map((v,i)=> v<=min+2 ? i : -1).filter(i=>i>=0);

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('trafficChart'), {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Czas jazdy (min)',
          data,
          borderColor:'#1565c0',
          backgroundColor:'rgba(21,101,192,0.12)',
          fill:true,
          tension:0.4,
          pointRadius: data.map((_,i)=> sweetIdx.includes(i)?14:6),
          pointBackgroundColor: data.map((_,i)=> sweetIdx.includes(i)?'#1b5e20':'#ff5252')
        }]
      },
      options:{
        responsive:true,
        plugins:{legend:{display:false}, title:{display:true,text:'Zielone punkty = najlepsze godziny!',font:{size:17}}},
        onClick:(e,els)=>{ if(els.length) { const i=els[0].index; dr.setDirections(sorted[i].obj); map.fitBounds(sorted[i].obj.routes[0].bounds); }}
      }
    });
  }

  function clearResults(){
    dr.setDirections({routes:[]});
    document.getElementById('result').innerHTML = 'Wypełnij pola…';
    document.getElementById('sweetWindow').style.display='none';
    document.getElementById('chartContainer').style.display='none';
    document.getElementById('googleMapsLink').style.display='none';
    if(chart){chart.destroy();chart=null;}
    allResults=[];
  }

  // Ładowanie mapy
  window.initMap = initMap;
</script>

<!-- ZAMIEN NA SWÓJ KLUCZ GOOGLE MAPS (Places + Directions) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjZtlDfYFM6yDqKGCoCrt4YA7uPVur-yk&libraries=places&callback=initMap"></script>
</body>
</html>