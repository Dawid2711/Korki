<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Najlepsza godzina wyjazdu – TYLKO dane historyczne (typical traffic)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8fafc; }
    #map { height: 500px; width: 100%; margin-top: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .controls { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .controls input, .controls button { padding: 10px; font-size: 16px; margin: 5px; border-radius: 6px; border: 1px solid #ddd; }
    #result { font-weight: bold; color: #1b5e20; background: #e8f5e9; padding: 20px; border-radius: 12px; margin: 20px 0; font-size: 20px; text-align: center; }
    .swap-btn { background: #1976d2; color: white; border: none; width: 44px; font-size: 20px; }
    #chartContainer { margin-top: 30px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
    h2 { color: #1976d2; }
  </style>
</head>
<body>
  <h2>Najlepsza godzina wyjazdu – na podstawie HISTORYCZNYCH korków (jak w Google Maps)</h2>

  <div class="controls">
    <input id="startInput" placeholder="Skąd (np. praca)" size="50">
    <button class="swap-btn" id="swapBtn" title="Zamień">Swap</button>
    <input id="endInput" placeholder="Dokąd (np. dom)" size="50">
  </div>

  <div class="controls">
    <label>Mogę wyjechać między:</label>
    <input type="time" id="departFrom" value="15:00">
    <label> a </label>
    <input type="time" id="departTo" value="19:00">

    <button id="bestTimeBtn">Znajdź najszybszą godzinę (dane historyczne)</button>
  </div>

  <div id="result">Wciśnij przycisk, a pokażę Ci najlepszą godzinę na podstawie korków z poprzednich tygodni</div>
  <div id="map"></div>
  <div id="chartContainer"><canvas id="trafficChart"></canvas></div>

  <script>
    let map, directionsService, directionsRenderer;
    let chart = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center: { lat: 52.2297, lng: 21.0122 }, zoom: 11 });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

      new google.maps.places.Autocomplete(document.getElementById("startInput"), { componentRestrictions: { country: "pl" } });
      new google.maps.places.Autocomplete(document.getElementById("endInput"),   { componentRestrictions: { country: "pl" } });

      document.getElementById("swapBtn").addEventListener("click", () => {
        const s = document.getElementById("startInput").value;
        const e = document.getElementById("endInput").value;
        document.getElementById("startInput").value = e;
        document.getElementById("endInput").value = s;
      });

      document.getElementById("bestTimeBtn").addEventListener("click", findBestHistoricalTime);
    }

    async function findBestHistoricalTime() {
      const start = document.getElementById("startInput").value.trim();
      const end   = document.getElementById("endInput").value.trim();
      const from  = document.getElementById("departFrom").value;
      const to    = document.getElementById("departTo").value;

      if (!start || !end || !from || !to) { alert("Wpisz oba adresy i przedział godzin!"); return; }

      document.getElementById("result").innerHTML = "Pobieram dane historyczne z Google Maps… (to potrwa ~20–40 sekund)";

      const times = [];
      const durations = [];

      let bestDuration = Infinity;
      let bestTime = null;
      let bestResult = null;

      const [fromH, fromM] = from.split(":").map(Number);
      const [toH, toM]     = to.split(":").map(Number);

      // Bierzemy przyszły wtorek (żeby był ten sam dzień tygodnia co najbliższy wtorek)
      const base = new Date();
      base.setDate(base.getDate() + ((2 + 7 - base.getDay()) % 7 || 7)); // najbliższy wtorek
      base.setHours(0,0,0,0);

      let current = new Date(base);
      current.setHours(fromH, fromM);
      const endTime = new Date(base);
      endTime.setHours(toH, toM);

      // daleka przyszłość – wymusza dane historyczne
      const fakeFuture = new Date(Date.now() + 365*24*60*60*1000);

      while (current <= endTime) {
        const timeStr = current.toLocaleTimeString("pl-PL", { hour: "2-digit", minute: "2-digit" });

        const result = await routeWithHistoricalTraffic(start, end, fakeFuture);
        if (result && result.routes[0].legs[0].duration_in_traffic) {
          const sec = result.routes[0].legs[0].duration_in_traffic.value;
          const min = Math.round(sec / 60);

          times.push(timeStr);
          durations.push(min);

          if (sec < bestDuration) {
            bestDuration = sec;
            bestTime = new Date(current);
            bestResult = result;
          }
        } else {
          times.push(timeStr);
          durations.push(null);
        }

        current.setMinutes(current.getMinutes() + 10);
      }

      if (bestTime) {
        const bestStr = bestTime.toLocaleTimeString("pl-PL", { hour: "2-digit", minute: "2-digit" });
        const bestMin = Math.round(bestDuration / 60);
        document.getElementById("result").innerHTML = 
          `NAJSZYBSZA GODZINA (dane historyczne z poprzednich tygodni):<br>
           <strong>${bestStr}</strong> → tylko <strong>${bestMin} minut</strong> w trasie!`;
        directionsRenderer.setDirections(bestResult);
      }

      drawHistoricalChart(times, durations, bestTime);
    }

    // KLUCZOWA FUNKCJA – wymusza dane historyczne
    function routeWithHistoricalTraffic(origin, destination, departureTime) {
      return new Promise(resolve => {
        directionsService.route({
          origin, destination,
          travelMode: google.maps.TravelMode.DRIVING,
          drivingOptions: {
            departureTime: departureTime,        // daleka przyszłość = dane historyczne
            trafficModel: "bestguess"
          },
          unitSystem: google.maps.UnitSystem.METRIC
        }, (result, status) => status === "OK" ? resolve(result) : resolve(null));
      });
    }

    function drawHistoricalChart(labels, data, bestTime) {
      const ctx = document.getElementById('trafficChart').getContext('2d');
      if (chart) chart.destroy();

      const bestIndex = labels.indexOf(bestTime.toLocaleTimeString("pl-PL", { hour: "2-digit", minute: "2-digit" }));

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Typowy czas przejazdu (dane historyczne)',
            data: data,
            borderColor: '#d32f2f',
            backgroundColor: 'rgba(211, 47, 47, 0.15)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: data.map((d, i) => i === bestIndex ? '#1b5e20' : '#d32f2f'),
            pointRadius: data.map((d, i) => i === bestIndex ? 10 : 5)
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'Typowy czas przejazdu co 10 minut – na podstawie danych historycznych Google', font: { size: 18 } }
          },
          scales: { y: { title: { display: true, text: 'Czas w korkach (minuty)' } } }
        }
      });
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh1_peFnB-COnDYYkzeXzdGCWVlDMC9w0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
