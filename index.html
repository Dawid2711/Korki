<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Traffic Advisor</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#6200ee; color:white; padding:1rem; text-align:center; font-size:1.5rem; }
main { padding:1rem; max-width:600px; margin:auto; }
label { display:block; margin-top:1rem; }
input, button, select { width:100%; padding:0.5rem; margin-top:0.3rem; font-size:1rem; }
button { background:#6200ee; color:white; border:none; cursor:pointer; margin-top:1rem; }
.waypoint { display:flex; margin-top:0.5rem; }
.waypoint input { flex:1; margin-right:0.5rem; }
canvas { margin-top:1rem; }
</style>
</head>
<body>
<header>Traffic Advisor</header>
<main>

<label>Punkt startowy:</label>
<input id="originInput" placeholder="Skąd jedziesz">

<label>Punkt końcowy:</label>
<input id="destinationInput" placeholder="Dokąd jedziesz">

<div id="waypointsContainer"></div>
<button id="addWaypointBtn">Dodaj punkt pośredni</button>

<label>Okno czasowe:</label>
<input type="time" id="fromTime" value="15:00">
<input type="time" id="toTime" value="17:00">

<label>Krok w minutach:</label>
<input type="number" id="stepMin" value="10">

<button id="calculateBtn">Oblicz najlepszy czas wyjścia</button>

<div id="results"></div>
<canvas id="chart" width="400" height="200"></canvas>

<script>
// --- TWÓJ GOOGLE API KEY ---
const apiKey = "AIzaSyDh1_peFnB-COnDYYkzeXzdGCWVlDMC9w0";

// --- DirectionsService ---
let directionsService;
let originPlace = null;
let destinationPlace = null;
let waypointPlaces = []; // tablica obiektów PlaceResult

// --- AUTOCOMPLETE Z GEOLOCALIZACJĄ ---
function initAutocomplete() {
    directionsService = new google.maps.DirectionsService();

    const options = {
        types: ['geocode'],
        componentRestrictions: { country: 'pl' },
        fields: ["formatted_address","geometry","name"]
    };

    // Start
    const originInput = document.getElementById('originInput');
    const originAutocomplete = new google.maps.places.Autocomplete(originInput, options);
    originAutocomplete.addListener('place_changed', () => {
        const place = originAutocomplete.getPlace();
        if (!place.geometry) {
            alert("Wybierz miejsce z listy podpowiedzi.");
            originInput.value = "";
            originPlace = null;
        } else {
            originPlace = place.formatted_address;
        }
    });

    // Koniec
    const destinationInput = document.getElementById('destinationInput');
    const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, options);
    destinationAutocomplete.addListener('place_changed', () => {
        const place = destinationAutocomplete.getPlace();
        if (!place.geometry) {
            alert("Wybierz miejsce z listy podpowiedzi.");
            destinationInput.value = "";
            destinationPlace = null;
        } else {
            destinationPlace = place.formatted_address;
        }
    });

    // Bias geolokalizacji
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const circle = new google.maps.Circle({
                center: { lat: position.coords.latitude, lng: position.coords.longitude },
                radius: 20000
            });
            originAutocomplete.setBounds(circle.getBounds());
            destinationAutocomplete.setBounds(circle.getBounds());
        });
    }
}

// --- DODAWANIE PUNKTÓW POŚREDNICH ---
const waypointsContainer = document.getElementById('waypointsContainer');
document.getElementById('addWaypointBtn').addEventListener('click', () => {
    const div = document.createElement('div');
    div.className='waypoint';

    const input = document.createElement('input');
    input.placeholder = "Punkt pośredni";

    const btn = document.createElement('button');
    btn.textContent = "X";
    btn.type = "button";
    btn.onclick = () => {
        const index = waypointPlaces.findIndex(p => p.input === input);
        if(index!==-1) waypointPlaces.splice(index,1);
        div.remove();
    };

    div.appendChild(input);
    div.appendChild(btn);
    waypointsContainer.appendChild(div);

    const options = { types:['geocode'], componentRestrictions:{country:'pl'}, fields:["formatted_address","geometry","name"] };
    const autocomplete = new google.maps.places.Autocomplete(input, options);
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if(!place.geometry) {
            alert("Wybierz miejsce z listy podpowiedzi.");
            input.value = "";
            waypointPlaces = waypointPlaces.filter(p => p.input !== input);
        } else {
            const existingIndex = waypointPlaces.findIndex(p=>p.input===input);
            if(existingIndex!==-1) waypointPlaces[existingIndex].place = place.formatted_address;
            else waypointPlaces.push({input, place: place.formatted_address});
        }
    });
});

// --- FETCH SEGMENT (DirectionsService) ---
async function fetchSegment(origin,destination,departUnix){
    return new Promise((resolve,reject)=>{
        directionsService.route({
            origin,
            destination,
            travelMode: google.maps.TravelMode.DRIVING,
            drivingOptions: {
                departureTime: new Date(departUnix*1000),
                trafficModel: 'BEST_GUESS'
            }
        }, (result,status)=>{
            if(status==='OK'){
                const durationSec = result.routes[0].legs[0].duration_in_traffic?.value 
                                    || result.routes[0].legs[0].duration.value;
                resolve(durationSec);
            } else {
                reject(status);
            }
        });
    });
}

async function fetchRouteTotalTime(points,departUnix){
    let total=0;
    for(let i=0;i<points.length-1;i++){
        total+= await fetchSegment(points[i],points[i+1],departUnix);
    }
    return total;
}

// --- EVENT LISTENER CALCULATE ---
document.getElementById('calculateBtn').addEventListener('click', async ()=>{
    if(!originPlace || !destinationPlace) {
        alert("Wybierz punkt startowy i końcowy z listy podpowiedzi.");
        return;
    }

    const waypoints = waypointPlaces.map(p=>p.place).filter(p=>p);
    const routePoints = [originPlace, ...waypoints, destinationPlace];

    const fromTime = document.getElementById('fromTime').value;
    const toTime = document.getElementById('toTime').value;
    const stepMin = parseInt(document.getElementById('stepMin').value);

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = 'Trwa obliczanie...';

    const chartLabels = [];
    const chartData = [];

    const fromDate = new Date();
    fromDate.setHours(...fromTime.split(':'));
    const toDate = new Date();
    toDate.setHours(...toTime.split(':'));

    for(let t=fromDate.getTime(); t<=toDate.getTime(); t+=stepMin*60*1000){
        const departUnix = Math.floor(t/1000);
        try{
            const totalSec = await fetchRouteTotalTime(routePoints,departUnix);
            const minLabel = `${Math.floor(t/3600000)}:${("0"+Math.floor((t/60000)%60)).slice(-2)}`;
            chartLabels.push(minLabel);
            chartData.push(Math.round(totalSec/60));
        }catch(err){
            console.error(err);
            chartLabels.push('err');
            chartData.push(null);
        }
    }

    resultsDiv.innerHTML = `Najkrótszy czas: ${Math.min(...chartData)} min`;

    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
        type:'line',
        data:{
            labels: chartLabels,
            datasets:[{
                label:'Czas przejazdu [min]',
                data: chartData,
                borderColor:'#6200ee',
                backgroundColor:'rgba(98,0,238,0.2)',
                fill:true,
                tension:0.3
            }]
        },
        options:{responsive:true,plugins:{legend:{display:true}}}
    });
});

// --- Inicjalizacja Google Maps API ---
const script = document.createElement('script');
script.src=`https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initAutocomplete`;
script.async=true;
document.head.appendChild(script);
</script>
</main>
</body>
</html>
